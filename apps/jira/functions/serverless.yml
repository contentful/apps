service: sls-apps-jira-backend

frameworkVersion: '>=3.0.0'

plugins:
  - serverless-domain-manager

custom:
  myStage: ${opt:stage, self:provider.stage}
  myEnvironment:
    FRONTEND_URL: ${file(./config/serverless-env.${self:custom.myStage}.yml):frontendUrl}
    OAUTH_REDIRECT_URI: ${file(./config/serverless-env.${self:custom.myStage}.yml):oauthRedirectUri}
    BASE_URL: ${file(./config/serverless-env.${self:custom.myStage}.yml):baseUrl}
  customDomain:
    domainName: ${file(./config/serverless-env.${self:custom.myStage}.yml):domainName}
    stage: ${self:custom.myStage}
    createRoute53Record: true
    endpointType: 'edge'
    securityPolicy: tls_1_2

provider:
  name: aws
  runtime: nodejs16.x
  stage: ${opt:stage, 'dev'}
  region: 'us-east-1'
  deploymentBucket:
    name: cf-apps-serverless-deployment

  deploymentPrefix: sls-apps-jira-backend

package:
  patterns:
    - 'built/**'
    - '!.git/**'
    - '!**/*.ts'

functions:
  oauth:
    handler: built/index.handleOauthRequest
    description: OAuth backend for Atlassian
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/atlassian_oauth_lambda
    environment:
      OAUTH_CREDENTIALS_SECRET_ID: apps/jira/${self:custom.myStage}/oauth-credentials
      OAUTH_REDIRECT_URI: ${self:custom.myEnvironment.OAUTH_REDIRECT_URI}
      FRONTEND_URL: ${self:custom.myEnvironment.FRONTEND_URL}
      OAUTH_TOKEN_EXCHANGE_ENDPOINT: https://auth.atlassian.com/oauth/token
    events:
      - http:
          path: auth
          method: get
          cors: true
          private: false
  connect:
    handler: built/index.handleConnectJsonRequest
    description: connect.json for JIRA
    role: arn:aws:iam::${env:AWS_ACCOUNT_ID}:role/jira_connect_lambda
    environment:
      BASE_URL: ${self:custom.myEnvironment.BASE_URL}
    events:
      - http:
          path: connect.json
          method: get
          cors: true
          private: false
